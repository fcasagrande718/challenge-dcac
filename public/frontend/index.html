<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Productos</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; background: #f8f9fb; color: #1f2d3d; }
        h1 { margin-bottom: 1rem; }
        form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem; padding: 1rem; background: #fff; border: 1px solid #e0e6ed; border-radius: 6px; }
        label { display: flex; flex-direction: column; font-weight: bold; font-size: 0.9rem; color: #3c4858; }
        input, textarea { margin-top: 0.35rem; padding: 0.5rem; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 1rem; }
        textarea { resize: vertical; min-height: 80px; }
        button { cursor: pointer; padding: 0.6rem 1rem; border: none; border-radius: 4px; font-weight: bold; color: #fff; background: #2d8cf0; transition: background 0.2s ease; }
        button:hover { background: #1a73e8; }
        table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid #e0e6ed; }
        th, td { padding: 0.75rem; border-bottom: 1px solid #e0e6ed; text-align: left; }
        th { background: #f0f4f8; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.03em; color: #52606d; }
        .actions { display: flex; gap: 0.5rem; }
        .muted { color: #8795a1; font-size: 0.9rem; }
        .secondary { background: #38b2ac; }
        .secondary:hover { background: #2c8c86; }
        .danger { background: #e53e3e; }
        .danger:hover { background: #c53030; }
        #message { margin-bottom: 1rem; padding: 0.75rem; border-radius: 4px; display: none; }
        #message.success { background: #def7ec; color: #046c4e; border: 1px solid #84e1bc; }
        #message.error { background: #fde8e8; color: #c81e1e; border: 1px solid #f5c2c0; }
    </style>
</head>
<body>
    <h1>Catálogo de Productos</h1>
    <div id="message"></div>
    <form id="product-form">
        <input type="hidden" id="product-id" />
        <label>Nombre
            <input type="text" id="nombre" required />
        </label>
        <label>Descripción
            <textarea id="descripcion"></textarea>
        </label>
        <label>Precio (ARS)
            <input type="number" step="0.01" id="precio" required />
        </label>
        <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
            <button type="submit" id="submit-btn">Guardar</button>
            <button type="button" id="reset-btn" class="secondary">Limpiar</button>
        </div>
    </form>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Precio (ARS)</th>
                <th>Precio (USD)</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="products-body">
            <tr><td colspan="6" class="muted">Cargando productos...</td></tr>
        </tbody>
    </table>

    <script>
        const form = document.getElementById('product-form');
        const productsBody = document.getElementById('products-body');
        const messageBox = document.getElementById('message');
        const submitBtn = document.getElementById('submit-btn');
        const resetBtn = document.getElementById('reset-btn');

        const api = {
            async request(path, options = {}) {
                const response = await fetch(path, {
                    headers: { 'Content-Type': 'application/json' },
                    ...options,
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok) throw new Error(data.error || 'Error desconocido');
                return data;
            },
            list() { return this.request('/productos'); },
            create(payload) { return this.request('/productos', { method: 'POST', body: JSON.stringify(payload) }); },
            update(id, payload) { return this.request(`/productos/${id}`, { method: 'PUT', body: JSON.stringify(payload) }); },
            remove(id) { return this.request(`/productos/${id}`, { method: 'DELETE' }); },
        };

        function showMessage(text, type = 'success') {
            messageBox.textContent = text;
            messageBox.className = type;
            messageBox.style.display = 'block';
            setTimeout(() => { messageBox.style.display = 'none'; }, 3000);
        }

        function renderProducts(products) {
            if (!products.length) {
                productsBody.innerHTML = '<tr><td colspan="6" class="muted">Sin productos disponibles</td></tr>';
                return;
            }

            productsBody.innerHTML = '';
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.id}</td>
                    <td>${product.nombre}</td>
                    <td>${product.descripcion || '<span class="muted">Sin descripción</span>'}</td>
                    <td>$${Number(product.precio).toFixed(2)}</td>
                    <td>${product.precio_usd !== null ? '$' + Number(product.precio_usd).toFixed(2) : '<span class="muted">Sin valor USD</span>'}</td>
                    <td class="actions">
                        <button class="secondary" data-action="edit" data-id="${product.id}">Editar</button>
                        <button class="danger" data-action="delete" data-id="${product.id}">Eliminar</button>
                    </td>
                `;
                productsBody.appendChild(row);
            });
        }

        async function loadProducts() {
            try {
                const products = await api.list();
                renderProducts(products);
            } catch (error) {
                productsBody.innerHTML = '<tr><td colspan="6" class="muted">No se pudieron cargar los productos</td></tr>';
                showMessage(error.message, 'error');
            }
        }

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const id = document.getElementById('product-id').value;
            const payload = {
                nombre: document.getElementById('nombre').value.trim(),
                descripcion: document.getElementById('descripcion').value.trim(),
                precio: Number(document.getElementById('precio').value),
            };

            try {
                if (id) {
                    await api.update(id, payload);
                    showMessage('Producto actualizado correctamente');
                } else {
                    await api.create(payload);
                    showMessage('Producto creado correctamente');
                }
                form.reset();
                document.getElementById('product-id').value = '';
                submitBtn.textContent = 'Guardar';
                await loadProducts();
            } catch (error) {
                showMessage(error.message, 'error');
            }
        });

        resetBtn.addEventListener('click', () => {
            form.reset();
            document.getElementById('product-id').value = '';
            submitBtn.textContent = 'Guardar';
        });

        productsBody.addEventListener('click', async (event) => {
            const action = event.target.dataset.action;
            const id = event.target.dataset.id;
            if (!action || !id) return;

            if (action === 'edit') {
                const row = event.target.closest('tr');
                document.getElementById('product-id').value = id;
                document.getElementById('nombre').value = row.children[1].textContent;
                const descriptionCell = row.children[2];
                document.getElementById('descripcion').value = descriptionCell.querySelector('span') ? '' : descriptionCell.textContent;
                document.getElementById('precio').value = Number(row.children[3].textContent.replace('$', ''));
                submitBtn.textContent = 'Actualizar';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }

            if (action === 'delete') {
                if (!confirm('¿Deseas eliminar este producto?')) return;
                try {
                    await api.remove(id);
                    showMessage('Producto eliminado');
                    await loadProducts();
                } catch (error) {
                    showMessage(error.message, 'error');
                }
            }
        });

        loadProducts();
    </script>
</body>
</html>
